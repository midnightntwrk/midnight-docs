name: Build

on:
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
        working-directory: .

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node (no Yarn cache here)
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install & Build (Corepack + auto-discovery)
        run: |
          set -euxo pipefail

          corepack enable
          corepack install
          export YARN_IGNORE_PATH=1

          echo "== Versions =="
          node -v
          echo "PATH yarn (may be Yarn 1; we won't rely on it):" || true
          yarn -v || true
          echo "Corepack yarn version (authoritative):"
          corepack yarn -v

          if [[ -f yarn.lock ]]; then
            corepack yarn install --immutable
          else
            export YARN_ENABLE_HARDENED_MODE=0
            corepack yarn install
          fi

          echo "== Discovering packages with a build script =="
          mapfile -t PKG_JSONS < <(find . \
            -type f -name package.json \
            -not -path "*/node_modules/*" \
            -not -path "*/.yarn/*" \
            -not -path "*/.git/*" \
            -not -path "./.github/*")

          has_build () {
            local pkg="$1"
            node -e "const p=require('$pkg');process.exit(!(p.scripts&&p.scripts.build));"
          }

          if has_build "./package.json"; then
            echo "::group::Build: /"
            corepack yarn build
            echo "::endgroup::"
          fi

          for pkg in "${PKG_JSONS[@]}"; do
            # skip the root package.json (already handled)
            if [[ "$pkg" == "./package.json" ]]; then
              continue
            fi
            dir="$(dirname "$pkg")"
            if has_build "$pkg"; then
              echo "::group::Build: $dir"
              corepack yarn --cwd "$dir" build
              echo "::endgroup::"
            fi
          done
