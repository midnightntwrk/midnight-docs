name: Build

on:
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      # âœ… Replace the old install + build steps with this block
      - name: Install & Build (Corepack + auto-discovery)
        run: |
          set -euxo pipefail

          # --- Force Yarn 4 from "packageManager" and ignore global Yarn 1 ---
          corepack enable
          corepack install
          export YARN_IGNORE_PATH=1

          echo "== Versions =="
          node -v
          echo "PATH yarn (may be Yarn 1; we won't rely on it):" || true
          yarn -v || true
          echo "Corepack yarn version (authoritative):"
          corepack yarn -v

          # --- Install at repo root (monorepo safe). Prefer immutable ---
          if [[ -f yarn.lock ]]; then
            corepack yarn install --immutable
          else
            export YARN_ENABLE_HARDENED_MODE=0
            corepack yarn install
          fi

          # --- Discover packages with a build script ---
          echo "== Discovering packages with a build script =="
          mapfile -t PKG_JSONS < <(find . \
            -type f -name package.json \
            -not -path "*/node_modules/*" \
            -not -path "*/.yarn/*" \
            -not -path "*/.git/*" \
            -not -path "./.github/*")

          has_build () {
            node -e "
              const fs = require('fs');
              const p = JSON.parse(fs.readFileSync(process.argv[1], 'utf8'));
              process.exit(p && p.scripts && p.scripts.build ? 0 : 1);
            " "$1"
          }

          # --- Build root if needed ---
          if has_build "./package.json"; then
            echo "::group::Build: /"
            corepack yarn build
            echo "::endgroup::"
          fi

          # --- Build each subpackage that has a build script ---
          for pkg in "${PKG_JSONS[@]}"; do
            if [[ "$pkg" == "./package.json" ]]; then
              continue
            fi
            dir="$(dirname "$pkg")"
            if has_build "$pkg"; then
              echo "::group::Build: $dir"
              corepack yarn --cwd "$dir" build
              echo "::endgroup::"
            fi
          done
